# This file is part of the project https://github.com/openSUSE/doc-kit
# DO NOT EDIT THIS FILE DOWNSTREAM. IT MAY BE OVERWRITTEN BY AN UPDATE.
#
# Copyright (c) 2014 Rick Salevsky <rsalevsky@suse.de>
# Copyright (c) 2014, 2015, 2016 Karl Eichwalder <ke@suse.de>
# Copyright (c) 2015, 2016, 2017, 2018, 2019 Stefan Knorr <sknorr@suse.de>
#


# AsciiDoc conditional text (e.g. for "to be released" information during beta).
LIFECYCLE_VALID := beta maintained unmaintained
ifndef LIFECYCLE
  LIFECYCLE := maintained
endif
ifneq "$(LIFECYCLE)" "$(filter $(LIFECYCLE),$(LIFECYCLE_VALID))"
  override LIFECYCLE := maintained
endif

daps_command = daps

xsltproc_command = xsltproc \
  --stringparam generate.toc "/article toc" \
  --stringparam generate.section.toc.level 0 \
  --stringparam section.autolabel 1 \
  --stringparam section.label.includes.component.label 2 \
  --stringparam variablelist.as.blocks 1 \
  --stringparam toc.section.depth 2 \
  --stringparam toc.max.depth 3 \
  --stringparam show.comments 0 \
  --xinclude \
  --nonet

mainfile = adoc/release-notes.adoc
dc_file = DC-release-notes
src_files = $(wildcard adoc/*.adoc adoc/*.xml)

daps_xslt_rn_dir = /usr/share/daps/daps-xslt/relnotes

profile_params = --adocattr lifecycle=$(LIFECYCLE)
text_params =

# temp files to be created by daps:
txt_file = build/release-notes/release-notes.txt
yast_profiled_file := build/.profiled/noprofile/release-notes.xml

.PHONY: clean pdf text single-html yast-html validate

all: validate single-html yast-html pdf text

validate: $(dc_file) $(src_files)
	$(daps_command) -d $< $(profile_params) validate

pdf: $(dc_file) $(src_files)
	$(daps_command) -d $< $(profile_params) pdf

single-html: $(dc_file) $(src_files)
	$(daps_command) -d $< $(profile_params) html --single --param="toc.section.depth=2"

yast-html: $(yast_profiled_file)
	$(xsltproc_command) $(daps_xslt_rn_dir)/yast.xsl $< > $@
	@echo "Created $@ for YaST HTML target."

# We need the text in ASCII to avoid issues when this is shown in text-only
# YaST.
text: $(txt_file)
	iconv -f UTF-8 -t ASCII//TRANSLIT -o /dev/stdout $< > $<.tmp
	mv $<.tmp $<

$(yast_profiled_file): $(dc_file) $(src_files)
	$(daps_command) -vv -d $< $(profile_params) profile


$(txt_file): $(dc_file) $(src_files)
	$(daps_command) -d $< $(profile_params) text $(text_params)

clean:
	rm -rf build/
